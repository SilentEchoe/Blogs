---
title: VirtualService
date: 2023-3-9 9:44:00
tags: [VirtualService,学习笔记]
category: VirtualService
---

### 服务网格是什么？

现代应用程序通常设计成微服务的分布式集合，每个服务执行一部分业务功能。服务网格是专门的基础设施，包含了组成这类体系结构的微服务网络。服务网格不仅描述了这个网络，而且还描述了分布式应用程序组件之间的交互。所以在服务之间传递数据都由服务网格控制和路由。

随着分布式服务的部署，比如基于Kubernetes的系统（规模和复杂性的增长）,可能会更加难以理解和管理。随着技术的迭代，需求变为了服务发现，负载平衡，故障恢复，度量和监视。微服务体系结构通常还有更复杂的操作需求，比如A/B测试,Canary部署,速率限制,访问控制,加密和端到端身份验证等。

服务网络可以通过可观测性,网络和安全策略来分隔应用程序的业务逻辑。通过服务网格可以链接微服务,让微服务更安全,可以更好的监控微服务。



### Istio 是什么？

Istio是一个开源服务网格,它透明地分层到现有的分布式应用程序上。它提供了一种统一和更有效的方式来保护,连接和监视服务。Istio是实现负载平衡，服务到服务身份验证和监视的路径（只需要更改很少的服务代码）它可以：

- 使用 TLS 加密、强身份认证和授权的集群内服务到服务的安全通信
- 自动负载均衡的 HTTP, gRPC, WebSocket，和 TCP 流量
- 通过丰富的路由规则、重试、故障转移和故障注入对流量行为进行细粒度控制
- 一个可插入的策略层和配置 API，支持访问控制、速率限制和配额
- 对集群内的所有流量(包括集群入口和出口)进行自动度量、日志和跟踪

Istio是为了可扩展性设计的，可以处理不同范围的部署需求。Istio的控制平面运行在Kubernetes上，可以将部署在该集群中的应用程序添加到您的网格中，将网格裸站到其他集群，甚至连接VM或者其他端点。



### Istio 概念

#### 流量管理

Istio 的流量路由规则可以更容易控制服务之间的流量和APi调用。Istio 的流量管理模型源于和服务一起部署的Envoy 代理。网格内服务发送和接受的所有 data plane 流量都由 Envoy 代理，这让控制网格内的流量变得异常简单，而且不需要对服务做任何的更改。 

> Data Plane 数据平面是网格的一部分，直接控制工作负载实例之间的通信。 Istio 的数据平面使用智能 [Envoy](https://istio.io/zh/docs/reference/glossary/#envoy) 代理部署成 sidecar 去调节和控制服务网格中发送和接受的流量。

Istio 在Kubernetes集群中安装后，会自动检测该集群中的服务和 endpoint，这是因为Istio要在网格中导流，需要知道所有的 endponit 在哪和属于哪个服务。

使用服务注册中心，Envoy代理可以将流量定向到相关服务。大多数基于微服务的应用程序，每个服务的工作负载都有多个实例来处理流量，这被称为负载均衡池。默认情况下 Envoy代理基于轮询调度模型在服务的负载均衡池内分发流量，按照顺序将请求分发给池中的成员，一旦所有服务实例均接收过一次请求后，就重新发给第一个池成员。

Istio 基本的服务发现和负载均衡能力会为我们提供一个可用的服务网格，比如A/B测试，将特定百分比流量定向到新版本的服务，或者为某些特定的服务实例提供不同的负载均衡策略

##### 虚拟服务

虚拟服务和目标规则是 Istio 流量路由功能的关键拼图。虚拟服务可以配置如何在服务网格内将请求路由到服务。每个虚拟服务包含一组路由规则，Istio 将每个给定的请求匹配到虚拟服务制定的实际目标地址。网格可以有多个虚拟服务，也可以没有，这取决于使用场景。

虚拟服务有助于增强Istio流量管理的灵活性和有效性，通过对客户端请求的目标地址与真实相应请求的目标工作负载进行解耦来实现。虚拟服务提供了丰富的方式，为发送这些工作负载指定不同的路由规则。

如果没有虚拟服务，Envoy 会在所有服务实例中使用轮询的负载均衡策略分发请求。

使用虚拟服务，可以为一个或者多个主机名指定流量行为。在虚拟服务中使用路由规则，告诉Envoy如何发送虚拟服务的流量到适当的目标，路由目标地址可以是同一服务的不同版本，也可以是完全不同的服务。

虚拟服务可以让您：

- 通过单个虚拟服务处理多个应用程序服务。如果您的网格使用 Kubernetes， 可以配置一个虚拟服务处理特定命名空间中的所有服务。映射单一的虚拟服务到多个“真实”服务特别有用， 可以在不需要客户适应转换的情况下，将单体应用转换为微服务构建的复合应用系统。 您的路由规则可以指定为“对 `monolith.com` 的 URI 调用转发到 `microservice A`” 等等。 
- 和[网关](https://istio.io/latest/zh/docs/concepts/traffic-management/#gateways)整合并配置流量规则来控制出入流量。

在某些情况下，您还需要配置目标规则来使用这些特性，因为这是指定服务子集的地方。 在一个单独的对象中指定服务子集和其它特定目标策略，有利于在虚拟服务之间更简洁地重用这些规则。

虚拟服务例子：

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: reviews  #虚拟服务名
spec:
  hosts:
  - reviews     #使用hosts字段列举虚拟服务的主机--用户指定的目标或是路由规则设定的目标。这是客户端向服务发送请求时使用的一个或多个地址
  http:         #http 字段包含了虚拟服务的路由规则，他们把流量发送到hosts字段指定的目标，一个路由规则包含了指定请求要流向哪个目标地址
  - match:      
    - headers:
        end-user:
          exact: jason  #该路由应用于来自 'jason' 用户的所有请求
    route:              #route 的destination 字段指定了符合此条件的流量实际目标地址，destination 的 host 必须是存在于 Istio 服务注册中心的实际目标地址，否则 Envoy 不知道该将请求发送到哪里。
    - destination:
        host: reviews
        subset: v2
  - route:
    - destination:
        host: reviews
        subset: v3

```

虚拟服务主机名可以是 IP 地址、DNS 名称，或者依赖于平台的一个简称（例如 Kubernetes 服务的短名称），隐式或显式地指向一个完全限定域名（FQDN）。您也可以使用通配符（“*”）前缀， 让您创建一组匹配所有服务的路由规则。虚拟服务的 `hosts` 字段实际上不必是 Istio 服务注册的一部分，它只是虚拟的目标地址。这让您可以为没有路由到网格内部的虚拟主机建模。



**路由规则**按从上到下的顺序选择，虚拟服务中定义的第一条规则有最高优先级。本示例中， 不满足第一个路由规则的流量均流向一个默认的目标，该目标在第二条规则中指定。因此， 第二条规则没有 match 条件，直接将流量导向 v3 子集。

官方建议提供一个默认的规则，这样让可以确保每个流经虚拟服务的流量至少能匹配到一条路由规则。







### Istio 实战

#### 部署

```shell
helm repo add istio https://istio-release.storage.googleapis.com/charts
helm repo update

kubectl create namespace istio-system
helm install istio-base istio/base -n istio-system --set defaultRevision=default

#helm 版本要大于3.7.1 错误信息：https://github.com/istio/istio/issues/52016
helm install istiod istio/istiod -n istio-system --wait
```





### 学习资料

《云原生服务网络Istio》

