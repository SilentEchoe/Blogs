---
title: eBPF 入门
date: 2024-12-12 11:04:00
tags: [eBPF]
category: eBPF
---

### eBPF是什么？

eBPF起源于Linux内核，它可以在特权上下文中(比如操作系统内核)运行沙盒程序。它可以安全有效地扩展内核功能，这意味着无需更改内核源码或加载内核模块就能完成拓展。

在操作系统中是实现可观测性，安全性和网络功能的理想场所，内核一直拥有控制和监督整个系统的特权，但又因为内核安全性和稳定性太高，相较于应用层，内核很难快速迭代。

eBPF允许在操作系统内核中运行沙盒程序，开发人员可以编写eBPF程序，在运行时向操作系统添加额外的功能。在JIT编译器和验证引擎的帮助下，操作系统确保它像本地编译的程序一样具备安全性和执行效率。比较常见的用途是网络监控，安全过滤，性能分析等。

BPF(Berkeley Packet Filter)最初代表一种网络过滤器，但是eBPF(extended BPF)不仅仅是包过滤，所以这个缩写不再有关联意义。eBPF现在是一个独立的术语。



### 如何工作？

eBPF主要分为三个步骤：加载，编译和执行。

1.eBPF 需要在内核中运行。一般由用户态的应用程序完成，它会通过系统调用来加载 eBPF程序。在加载过程中，内核会将eBPF程序的代码复制到内核空间。

2.eBPF 需要经过编译，通常情况下是由Clang/LLVM 编译器完成，形成字节码后将用户态的字节码装载进内核，Verifier 会对要注入内核的程序进行一些内核安全机制的检查，这点非常重要，这保证了eBPF程序不会破坏Linux内核的稳定性和安全性。在检查过程中，内核会对 eBPF程序的代码进行分析，比如一些敏感操作是会被禁止的，比如系统调用，内存访问等。

3.当通过内核安全机制检查后，它就可以在内核中正常运行了，通过一个JIT编译步骤将程序的通用字节码转换为机器特定指令集，以优化程序的执行速度。



eBPF程序由事件驱动组成，当内核或应用程序通过某个钩子点时运行。预定义的钩子包括系统调用，函数入口/退出，内核跟踪点，网络事件等。当预定义的钩子不能满足特定需求，可以创建内核探针(kprobe)或用户探针(uprobe)在内核或用户程序中附加eBPF程序。

大部分情况，eBPF不会直接使用，而是通过Cilium bcc bpftrace 项目间接使用，这些项目提供了 eBPF 之上的抽象，不需要直接编写程序，提供基于意图来定义实现的能力，然后再用 eBPF实现。









