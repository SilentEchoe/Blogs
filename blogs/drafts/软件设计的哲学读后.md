---
title: 《软件设计的哲学》读后
date: 2024-10-10 19:08:00
tags: [设计,读后]
category: 设计

---

### 软件设计的哲学

降低复杂性的方式有两种：

1.通过使代码更简单，更显而易见来降低复杂性。例如：消除特例或以一致性的方式使用标识符来降低复杂性。

2.将复杂性封装起来(模块化设计)



> 不应该把“能工作的代码”当作首要的目标，代码仅仅只是工作是不够的，虽然代码首先且必须能工作。

必须投入一定时间来改进系统设计，不过即使投入大量的时间也不免决策失误，随着时间的推移这些错误会越来越明显。当发生错误的决策时不要置之不理，要一点一点修复它，改进它。

在《设计原本》一书中提到过，第一次设计某个模块时可能不是最优的解决方案，得试几次以后才可能找到最合适的方案。

> 在将自己的时间用于投资设计时，应该占总开发周期的百分之十到百分之二十。

当一段代码在几个月后，大部分开发者已经完全忘记当初实现它的大部分想法。所以注释和测试，文档很重要。





#### 模块化应该如何设计？

在理想的情况下每一个模块都完全独立于其他模块：开发者可以在个模块内独立工作，而对其他的模块一无所知，基于这样理想的系统，那么系统的复杂度就是设计得最差的模块的复杂度。

现实生活中这样的理想的事是不可能的，因为模块之间会相互依赖，互相调用，如果你更改了其中一个模块，那么可能需要更改它的上下游其他模块。比如你更改了某一个函数的入参，那么不可避免需要更改其他模块的传值。

为了更好管理这些问题，模块一般会分成两个部分：接口和实现。接口只描述模块提供的功能，而不描述具体实现的细节。

抽象这个词和模块化密切相关，抽象之所以有用，是因为它使我们更容易思考和处理复杂事物。 

设计一个新模块的时候，应该仔细考虑可以在模块中隐藏哪些信息。如果可以隐藏信息，则应该还能简化模块的接口，会让模块更深。





透传方法很糟糕，因为它不提供任何新功能，同时它也会将层级变得更复杂。

调度器是一种方法，它使用自己的参数从其他几种方法中选择一种来调用；然后，它将其大部分或全部参数传递给选定的方法。调度程序的签名通常与其调用的方法的签名相同。尽管如此，调度程序还是提供了有用的功能:它选择其他几种方法中的哪一种来执行每个任务。



全局变量不是一个好主意，全局变量使得不可能在同一过程中创建同一系统的两个独立实例，因为对全局变量的访问会发生冲突。

> 设想你写了一个轻量级 HTTP 服务器库，并在同一 JVM 进程内启动两个服务器对象：一个监听 8080 端口、另一个监听 9090 端口。若该库把“当前端口号”和“线程池”保存在静态全局变量里，那么第二次启动会覆盖第一次的配置，或直接抛出端口占用异常。编写并行单元测试、模拟双活部署、或对比不同配置就都行不通。 
>
> 在研究或教学中，经常把多节点 Raft 实例全放进同一进程里，通过内存队列模拟网络。若实现细节里把“当前任期(term)”或“日志索引”做成全局变量，所有节点将不约而同地修改同一份数据，根本无法重现真实的分布式行为，也无法验证算法正确性。 
> 测试脚本想在同一进程里并排启动两套微服务，每套微服务各自持有一个连接池并连向不同数据库实例做对比。但如果连接池实现用全局变量缓存“默认配置”和“全局统计指标”，两套微服务的度量数据会混在一起，造成测试结果失真。

作者建议使用上下文对象来解决这个问题。上下文存储应用程序的所有全局状态。每个系统实例只有一个上下文对象，而上下文允许系统的多个实例在单个进程中共享，每个实例都有自己的上下文。

上下文对象统一了所有系统全局信息的处理，并且不需要传递变量。如果需要添加新变量，则可以将其添加到上下文对象；除了上下文的构造函数和析构函数外，现有代码均不受影响。由于上下文全部存储在一个位置，因此上下文可以轻松识别和管理系统的全局状态。上下文也便于测试：测试代码可以通过修改上下文中的字段来更改应用程序的全局配置。如果系统使用传递变量，则实施此类更改将更加困难。

上下文远非理想的解决方案。存储在上下文中的变量具有全局变量的大多数缺点。例如，为什么存在特定变量或在何处使用特定变量可能并不明显。没有纪律，上下文会变成巨大的数据抓包，从而在整个系统中创建不明显的依赖关系。上下文也可能产生线程安全问题；避免问题的最佳方法是使上下文中的变量不可变。不幸的是，我没有找到比上下文更好的解决方案。



麻烦开发者总比麻烦使用者要好。

> 作为开发人员，很容易以相反的方式行事：解决简单的问题，然后将困难的问题推给其他人。如果出现不确定如何处理的条件，最简单的方法是抛出异常并让调用者处理它。如果不确定要实施什么策略，则可以定义一些配置参数来控制该策略，然后由系统管理员自行确定最佳策略。

这种方法会加剧复杂性，如果一个类抛出异常，那么这个类的所有调用者都必须处理该异常。

在开发模块时，为了减少用户的痛苦，要找机会给自己多吃一点苦。





什么情况下需要将两个功能模块合并？

如果是紧密相关，则代码组合在一起是有益的，如果各个部分无关，则最好分开。

那么怎么判断它是紧密相关的？

1.共享信息：两段代码都取决于特定类型文档的语法。

2.共同使用：使用其中一段代码的人都可能同时使用另外一段代码。作为反例，磁盘块高速缓存几乎总是包含哈希表，但是哈希表可以在许多不涉及块高速缓存的情况下使用。因此，这些模块应该分开。

3.概念重合：如果存在一个更高级的类，它将包含这两段代码。例如，搜索子字符串和大小写转换都属于字符串操作类别。流控制和可靠的交付都属于网络通信的范畴。

4.相同理解：如果两段代码分别在不同地方，单看其中一段代码无法理解其用途，放在一起后则能理解其意图，则代表需要放在一起。



重复的代码需要消除，
